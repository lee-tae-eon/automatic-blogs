# ==============================================================================
# Workflow ì´ë¦„: Build and Release
# ì„¤ëª…: ì½”ë“œê°€ í‘¸ì‹œë˜ë©´ Windowsì™€ Mac í™˜ê²½ì—ì„œ ê°ê° ì•±ì„ ë¹Œë“œí•˜ê³  ì„¤ì¹˜ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
# ==============================================================================
name: Build and Release

# 1. íŠ¸ë¦¬ê±°(Trigger): ì´ ì›Œí¬í”Œë¡œìš°ê°€ ì–¸ì œ ì‹¤í–‰ë ì§€ ì •ì˜í•©ë‹ˆë‹¤.
on:
  # 'main' ë¸Œëœì¹˜ì— ì½”ë“œê°€ í‘¸ì‹œ(push)ë˜ì—ˆì„ ë•Œ ìë™ ì‹¤í–‰
  push:
    branches: ["release"]
  # GitHub ì›¹ì‚¬ì´íŠ¸ 'Actions' íƒ­ì—ì„œ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•˜ê²Œ í•¨ (í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:
    inputs:
      build_target:
        description: "ë¹Œë“œí•  ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - mac
          - windows

# 2. ì‘ì—…(Jobs): ì‹¤ì œë¡œ ì‹¤í–‰ë  ì‘ì—…ë“¤ì˜ ëª©ë¡ì…ë‹ˆë‹¤.
# build-windowsì™€ build-macì€ ë³‘ë ¬(ë™ì‹œ)ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.
jobs:
  # ----------------------------------------------------------------------------
  # [ì‘ì—… 1] ìœˆë„ìš°ìš© ë¹Œë“œ (.exe ìƒì„±)
  # ëª©ì : Mac ê°œë°œ í™˜ê²½ì—ì„œëŠ” ë§Œë“¤ ìˆ˜ ì—†ëŠ” 'ìœˆë„ìš°ìš© SQLite'ë¥¼ í¬í•¨í•œ ì‹¤í–‰ íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤.
  # ----------------------------------------------------------------------------
  build-windows:
    # ì „ì²´ì´ê±°ë‚˜ ìœˆë„ìš°ì¼ë•Œ
    if: ${{ github.event_name == 'push' || github.event.inputs.build_target == 'all' || github.event.inputs.build_target == 'windows' }}
    # ì‹¤í–‰ í™˜ê²½: GitHubê°€ ì œê³µí•˜ëŠ” ìµœì‹  Windows ê°€ìƒ ì»´í“¨í„°ë¥¼ ì„ëŒ€í•©ë‹ˆë‹¤.
    runs-on: windows-latest

    steps:
      # (1) ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      # í˜„ì¬ ë¦¬í¬ì§€í† ë¦¬ì˜ ì†ŒìŠ¤ ì½”ë“œë¥¼ ê°€ìƒ ì»´í“¨í„°ë¡œ ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤.
      - name: Check out code
        uses: actions/checkout@v4

      # (2) Node.js ì„¤ì •
      # ë¹Œë“œì— í•„ìš”í•œ Node.js 20 ë²„ì „ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.13

      # (3) PNPM íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € ì„¤ì¹˜
      # ìš°ë¦¬ í”„ë¡œì íŠ¸ëŠ” pnpmì„ ì“°ë‹ˆê¹Œìš”.
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      # (4) .env íŒŒì¼ ë³µì› (ì¤‘ìš”! ğŸ”)
      # GitHub Secretsì— ì €ì¥í•´ë‘” API í‚¤ë“¤ì„ êº¼ë‚´ì„œ ê°€ìƒ ì»´í“¨í„°ì— .env íŒŒì¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
      # (ì†ŒìŠ¤ ì½”ë“œì—ëŠ” ë³´ì•ˆìƒ .envê°€ ì—†ìœ¼ë‹ˆê¹Œ ì´ ê³¼ì •ì´ í•„ìˆ˜ì…ë‹ˆë‹¤)
      - name: Generate .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env
        shell: bash

      # (5) ì˜ì¡´ì„± ì„¤ì¹˜ (ê°€ì¥ ì¤‘ìš”í•œ ë‹¨ê³„! ğŸ”¥)
      # ì—¬ê¸°ì„œ 'pnpm install'ì„ í•˜ë©´, better-sqlite3ê°€ 'ìœˆë„ìš°ìš©(C++ ë°”ì´ë„ˆë¦¬)'ìœ¼ë¡œ ì»´íŒŒì¼ë©ë‹ˆë‹¤.
      # ìš°ë¦¬ê°€ Macì—ì„œ ë¹Œë“œí•  ë•Œ ê²ªì—ˆë˜ í˜¸í™˜ì„± ë¬¸ì œê°€ ì—¬ê¸°ì„œ í•´ê²°ë©ë‹ˆë‹¤.
      - name: Install Dependencies
        run: pnpm install

      # (6) Core íŒ¨í‚¤ì§€ ë¹Œë“œ
      # ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—­í• ì„ í•˜ëŠ” core íŒ¨í‚¤ì§€ë¥¼ ë¨¼ì € ë¹Œë“œí•©ë‹ˆë‹¤.
      - name: Build Core Package
        run: pnpm --filter @blog-automation/core build

      # (7) Desktop ì•± ë¹Œë“œ ë° íŒ¨í‚¤ì§•
      # React ë¹Œë“œ -> Electron ë¹Œë“œ -> .exe íŒ¨í‚¤ì§•ì´ ìˆœì°¨ì ìœ¼ë¡œ ì¼ì–´ë‚©ë‹ˆë‹¤.
      # electron-builderê°€ ìœˆë„ìš° í™˜ê²½ì„ì„ ê°ì§€í•˜ê³  .exeë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤.
      - name: Build Desktop App
        run: pnpm --filter @blog-automation/desktop build
        env:
          # GitHub API í˜¸ì¶œ ë“±ì„ ìœ„í•´ í† í°ì„ ì£¼ì…í•©ë‹ˆë‹¤ (ìë™ ìƒì„±ë¨)
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # (8) ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (Artifact)
      # ê°€ìƒ ì»´í“¨í„°ëŠ” ì‘ì—…ì´ ëë‚˜ë©´ ì‚­ì œë˜ë¯€ë¡œ, ìƒì„±ëœ .exe íŒŒì¼ì„
      # GitHub ì €ì¥ì†Œì˜ 'Artifacts' ê³µê°„ìœ¼ë¡œ ì—…ë¡œë“œí•´ì„œ ìš°ë¦¬ê°€ ë‹¤ìš´ë°›ì„ ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.
      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BlogAutomation-Windows # ë‹¤ìš´ë¡œë“œë  ì••ì¶• íŒŒì¼ ì´ë¦„
          path: apps/desktop/dist_electron/*.exe # ì—…ë¡œë“œí•  íŒŒì¼ ê²½ë¡œ (exeë§Œ)

  # ----------------------------------------------------------------------------
  # [ì‘ì—… 2] ë§¥ìš© ë¹Œë“œ (.dmg ìƒì„±)
  # ëª©ì : ìœˆë„ìš° ë¹Œë“œí•˜ëŠ” ê¹€ì— ë§¥ìš©ë„ ê°™ì´ ë¹Œë“œí•´ì„œ í•œ ê³³ì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.
  # ----------------------------------------------------------------------------
  build-mac:
    # "ì „ì²´(all)" ì´ê±°ë‚˜ "ë§¥(mac)"ì„ ì„ íƒí–ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: ${{ github.event_name == 'push' || github.event.inputs.build_target == 'all' || github.event.inputs.build_target == 'mac' }}
    # ì‹¤í–‰ í™˜ê²½: ìµœì‹  macOS ê°€ìƒ ì»´í“¨í„°
    runs-on: macos-latest

    steps:
      # (1) ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Check out code
        uses: actions/checkout@v4

      # (2) Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24.13

      # (3) PNPM ì„¤ì¹˜
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      # (4) .env íŒŒì¼ ë³µì›
      - name: Generate .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env

      # (5) ì˜ì¡´ì„± ì„¤ì¹˜
      # ì—¬ê¸°ì„œ ì‹¤í–‰í•˜ë©´ better-sqlite3ê°€ 'Macìš©'ìœ¼ë¡œ ì»´íŒŒì¼ë©ë‹ˆë‹¤.
      - name: Install Dependencies
        run: pnpm install

      # (6) Core íŒ¨í‚¤ì§€ ë¹Œë“œ
      - name: Build Core Package
        run: pnpm --filter @blog-automation/core build

      # (7) Desktop ì•± ë¹Œë“œ
      - name: Build Desktop App
        run: pnpm --filter @blog-automation/desktop build
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # âš ï¸ ë§¥ ë¹Œë“œ ì‹œ ì¸ì¦ì„œê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆëŠ”ë°,
          # ì´ë¥¼ ë¬´ì‹œí•˜ê³  ë¹Œë“œë¥¼ ì§„í–‰í•˜ê²Œ í•˜ëŠ” ì˜µì…˜ì…ë‹ˆë‹¤. (í…ŒìŠ¤íŠ¸ìš© ë¹Œë“œì— ì í•©)
          CSC_IDENTITY_AUTO_DISCOVERY: false

      # (8) ê²°ê³¼ë¬¼ ì—…ë¡œë“œ
      # ìƒì„±ëœ .dmg íŒŒì¼ì„ GitHubì— ì €ì¥í•©ë‹ˆë‹¤.
      - name: Upload Mac Artifact
        uses: actions/upload-artifact@v4
        with:
          name: BlogAutomation-Mac
          path: apps/desktop/dist_electron/*.dmg
