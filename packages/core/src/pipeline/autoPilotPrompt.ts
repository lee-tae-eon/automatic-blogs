import { BlogPostInput, AutoPilotStrategy } from "../types/blog";
import { getPersonaDetail } from "../persona/persona.config";
import { getPersonaExamples } from "../persona/persona.example";
import { getToneInstruction } from "../tone/tone_config";

/**
 * [v3.34] Auto-Pilot 전용 정밀 프롬프트 엔진
 * - 헤딩(##) 마크다운 강제화 (NaverEditor 스타일 인식용)
 * - 모바일 호흡법 및 테이블 규격 동기화
 */
export function generateAutoPilotPrompt(input: BlogPostInput): string {
  const strategy = input.strategy as AutoPilotStrategy;
  if (!strategy) {
    throw new Error("Auto-Pilot 모드이나 전략 데이터가 누락되었습니다.");
  }

  const personaDetail = getPersonaDetail(input.persona);
  const examples = getPersonaExamples(input.persona);
  const toneInstruction = getToneInstruction(input.tone);

  // 1. 뉴스 및 실시간 정보 (Language Lock 및 출처 필터링 적용)
  let newsInstruction = "";
  if (input.latestNews) {
    newsInstruction = `
# 📰 실시간 최신 정보 및 출처 원칙 (2026년 2월 기준)
당신의 내장 지식보다 아래 정보를 최우선순위로 반영하되, 다음 원칙을 **절대 준수**하세요.

## 🚫 [ULTRA CRITICAL] 정보원 및 출처 표기 금지 규칙
1. **블로그/카페 배제**: 제공된 정보 중 블로그(Naver, Tistory 등), 카페(Naver, Daum 등), 커뮤니티(DC, Ruliweb 등) 성격의 글은 **절대 정보원으로 사용하지 마세요.** 오직 공식 뉴스, 보도자료, 전문 사이트의 정보만 신뢰하세요.
2. **본문 내 출처 기재 금지**: 본문(\`content\`) 내에 \`(매체명)\`, \`[뉴스]\`, \`[1]\`, \`출처: ...\` 등 어떠한 형태의 출처 마커도 붙이지 마세요. 출처는 오직 JSON의 \`references\` 필드에만 포함해야 합니다.
3. **언어 원칙**: 제공된 정보가 영어라도 **반드시 100% 한국어**로만 작성하세요.

${input.latestNews}
`;
  }

  // 2. 오토파일럿 전략 및 페르소나 (Authority)
  const writingStyleSection = `
## ✍️ [CRITICAL] 작문 스타일 및 문체 지시 (Anti-Machine)
당신은 기계적인 AI가 아닌, 독자의 몰입을 이끌어내는 **전문 칼럼니스트**입니다.
1. **마이크로 브리딩 (Micro-Breathing) [ULTRA CRITICAL]**:
   - 한 문장의 길이를 **최대 40~50자 이내**로 짧고 간결하게 유지하세요.
   - 문장이 길어질 경우, 반드시 **쉼표(,) 바로 뒤에서 줄바꿈(\n)**을 수행하여 시각적 리듬을 만드세요. (종결 어미가 다음 줄로 툭 떨어지는 현상 방지)
2. **문맥 기반 어미 변화**: 문장의 성격에 따라 어미를 변화시키세요. (사실 전달: ~입니다 / 현장감/생동감: ~죠, ~거든요 / 결론/강조: ~인 셈입니다)
3. **리듬감(Rhythm)**: 모든 문장의 길이가 비슷하면 글이 지루해집니다. [단문 - 단문 - 장문] 또는 [장문 - 단문] 식으로 문장 길이를 극단적으로 섞으세요.
4. **패턴 파괴(Pattern Breaking)**: 어떤 종결 어미든 **3번 이상 연속으로 같은 계열을 쓰면 실패**로 간주합니다.
5. **단어 보존(Word Integrity)**: 단어 중간이나 고유명사 내부에 불필요한 공백이나 줄바꿈을 절대 넣지 마세요.
${personaDetail.writingTips ? personaDetail.writingTips.map((tip) => ` - ${tip}`).join("\n") : ""}

## ✅ 이 페르소나의 모범 사례 (Style Examples)
글을 쓸 때 아래 예시 문장의 느낌과 리듬을 참고하세요:
${examples.goodSentences.map((s) => `- "${s}"`).join("\n")}
${examples.transitions.length > 0 ? `\n**자연스러운 문장 연결 예시**:\n${examples.transitions.map((t) => `- "${t}..."`).join("\n")}` : ""}
`;

  const listInstruction = (input.topic.includes("리스트") || input.persona === "informative")
    ? `
## 📋 [CRITICAL] 정보 구조화 및 리스트(List) 중심 구성 지시
- **리스트 중심 작법**: 정보를 긴 문단으로 서술하지 마세요. 핵심 데이터, 절차, 특징 등은 반드시 **마크다운 리스트(\`-\`)**를 활용하여 시각적으로 분리하세요.
- **계층 구조(Depth) 활용**: 단순히 나열하지 말고 하위 항목(들여쓰기)을 사용하여 정보의 인과관계나 세부 내용을 구조화하세요.
- **🚨 콜론(:) 사용 제한**: '항목: 내용' 식의 단순 나열보다 리스트의 깊이를 활용하는 것이 가독성에 더 좋습니다.
- **구조 예시**:
  - 📌 주요 특징
    - 세부 기능 1: 구체적인 혜택 및 장점
    - 세부 기능 2: 실제 활용 사례
- 본문의 핵심 정보 중 50% 이상을 리스트와 표를 적절히 섞어 시각적으로 배치하세요.
`
    : "";

  const strategicCore = `
# 🎭 역할 및 전략 지침 (필수 준수)
당신은 분석된 경쟁사들의 장점을 흡수하고 단점을 보완하는 **전략적 작가**이자 **${personaDetail.role}**입니다.

## 🚫 [CRITICAL] 페르소나 절대 금지 표현
아래 리스트의 표현을 단 하나라도 사용하면 글의 전문성이 무너집니다. **절대 금지**:
${personaDetail.forbidden.map((f) => ` - **${f}**`).join("\n")}

## 🎵 기본 톤앤매너 (Tone)
${toneInstruction}

${writingStyleSection}

${listInstruction}

## 1. 차별화 전략
${strategy.differentiationStrategy}

## 2. 세만틱 SEO 및 전문성 (New)
검색 엔진이 이 글을 '전문적인 문서'로 판단하도록 아래 연관어들을 본문에 자연스럽게 녹여내세요.
- **필수 연관 키워드**: ${input.keywords?.join(", ")}
- **전략**: 위 단어들을 단순히 나열하지 말고, 각 단어의 의미나 맥락을 설명하며 전문성을 드러내세요.

## 3. 문체 및 스타일 DNA
${strategy.styleDNA}
- **정체성 숨기기 [ULTRA CRITICAL]**: 
  - 당신이 누구인지 밝히지 마세요. "안녕하세요, 리포터입니다", "전문가로서 말씀드리면" 같은 모든 형태의 자기소개를 절대 금지합니다.
  - "리포터", "분석가", "리뷰어" 등 당신의 **페르소나 명칭을 본문에 단 한 번도 쓰지 마세요.**
  - 오직 정보와 분석에만 집중하여 글 자체로 당신의 전문성을 증명하세요.
- **말투**: 해요체를 적절히 섞되, 신뢰감을 주는 **하십시오체** 또는 **평어체(-다)**를 기본으로 합니다.

## 4. 구조 및 아웃라인
반드시 아래 5개 섹션을 충실히 채우세요:
${(strategy.suggestedOutline || []).join(" -> ")}
`.trim();

  // ✅ 3. 레이아웃 및 가독성 (Manual 모드와 동일한 엔진 적용)
  const layoutRules = `
# 🎨 레이아웃 및 [CRITICAL] 강조 규칙

${input.useImage !== false ? `
## 🖼️ [CRITICAL] 이미지 삽입 규칙
- 본문 중간에 이미지가 들어갈 위치에 **[이미지: 검색 키워드]** 태그를 삽입하세요. (최대 2개)
- 키워드는 Pexels에서 검색 가능하도록 구체적으로 작성하세요.
` : ""}

당신의 글은 텍스트로만 이루어져 지루합니다. 반드시 **볼드체(**...**)**를 사용하여 시각적 포인트를 만드세요.
- **핵심 강조**: 문맥상 가장 중요한 **단어**나 **짧은 구**만 굵게(Bold) 처리하세요.
- **분량 제한 [ULTRA CRITICAL]**: 한 문장에 굵은 글씨는 **최대 2단어**를 넘지 마세요. 문장 전체나 문단 전체를 굵게 만드는 것은 절대 금지입니다.
- **빈도**: 각 문단마다 핵심적인 부분에만 1~2회 사용하세요. 너무 잦은 강조는 오히려 가독성을 해칩니다.

## 📐 [CRITICAL] 헤딩(Heading) 및 소제목 규칙
이 규칙을 지키지 않으면 에디터 스타일이 적용되지 않습니다.
1. **마크다운 필수**: 모든 소제목(Outline 항목)은 반드시 **\`##\` (H2)** 또는 **\`###\` (H3)**를 사용하세요.
   - ❌ 나쁜 예: **1. 서론** (볼드 처리 금지)
   - ⭕ 좋은 예: ## 1. 서론
2. **구조 일치**: JSON의 \`outline\`에 있는 항목들은 본문에 반드시 \`##\` 헤딩으로 존재해야 합니다.

## 📌 [v5.1] 핵심 체크포인트 (Post-it Style) 규칙
글의 중간이나 마지막에 독자가 반드시 기억해야 할 핵심 요약이나 팁을 **하나** 작성하세요.
- **형식**: 반드시 \`<div class="checkpoint">내용</div>\` 태그로 감싸야 합니다.
- **내용**: 3~4줄 정도의 짧고 강렬한 문장으로 구성하며, 가독성을 위해 문장 사이에 **반드시 \`<br>\` 태그를 넣어 줄바꿈**을 수행하세요.
- **스타일**: 제목 부분은 **\`[핵심 체크 포인트]\`**와 같이 볼드로 강조하고, 이후 내용을 리스트 형태나 간결한 문체로 작성하세요.
- **예시**:
<div class="checkpoint">
**[핵심 체크 포인트]**<br>
1. 정맥 순환에 문제가 있을 때 흔히 보이는 패턴이에요.<br>
2. 누워서 다리를 심장보다 높게 올리면 통증이 완화됩니다.<br>
(정확한 건 초음파 검사를 꼭 해보세요!)
</div>

## 📱 [CRITICAL] 모바일 가독성 절대 규칙 (Mobile Breathing)
이 글은 100% 모바일 사용자가 읽습니다. **"벽돌 같은 텍스트(Wall of Text)"는 즉시 실패로 간주합니다.**
1. **호흡 끊기**:
   - 절대로 4문장 이상을 한 문단에 이어 쓰지 마세요.
   - **2~3문장(최대 150자)**이 모이면 무조건 줄을 바꾸세요.
   - 문단 사이에는 반드시 **빈 줄(Enter 2번)**을 넣어 시각적 여백을 확보하세요.
2. **단문 위주**: 접속사를 줄이고 문장을 짧게 끊어치세요.

## 📊 데이터 시각화 및 차트 규칙
- **차트 삽입**: 본문 내용 중 비교, 통계, 추이 등 **수치 데이터가 포함된 경우에만** [차트: {JSON 데이터}] 태그를 삽입하세요.
- **제외 대상**: 연예 소식, 방송 리뷰, 가벼운 에세이 등 수치 데이터가 중요하지 않은 주제는 차트를 절대 넣지 마세요.
- **차트 유형별 권장 사용**:
  - \`bar\`: 항목 간의 일반적인 수치 비교 (세로형)
  - \`horizontalBar\`: 항목 이름이 길거나 순위(Rank)를 보여줄 때 (가로형)
  - \`pie\` 또는 \`doughnut\`: 전체 대비 비율을 보여줄 때
  - \`line\`: 시간에 따른 변화 추이를 보여줄 때
- **데이터 형식**: { "type": "bar" | "horizontalBar" | "pie" | "doughnut" | "line", "title": "차트 제목", "labels": ["항목1", "항목2"], "data": [10, 20] }
- **위치**: 해당 수치를 설명하는 문단 바로 아래에 배치하세요. (최대 1개)

## ✨ 시각적 요소 및 컬러링 강조 규칙
${input.useImage === false ? "- **이미지 생성 금지**: 본문에 어떠한 이미지 관련 태그(`![...]`, `[이미지:...]`)도 **포함하지 마세요.**" : ""}
- **데이터 강조 문법**: 핵심 데이터(++파스텔 파랑++)를 사용하여 정보의 가독성을 높이세요.
- **[ULTRA CRITICAL] 강조 대상 및 규칙**:
  1. **팩트 위주 강조**: '심각한 상황', '놀라운 결과' 같은 **감성적/형용사적 표현에는 절대 사용하지 마세요.** 
  2. **대상 지정**: 오직 **정확한 수치(예: 15.4%), 날짜(예: 2월 21일), 핵심 통계** 등에만 적용하세요.
  3. **사용 빈도**: 포스팅 전체에서 **딱 2회 이내**로 극도로 아껴서 사용하세요.
  4. **형식**: `++데이터++` 형식을 사용하며, 한 번에 **5자 이내**로 짧게 끊으세요.
`.trim();

  // 4. 작성 미션 및 체크리스트
  const mission = `
# 🎯 작성 미션
**${input.topic}** 주제로 포스트를 작성하세요.

## ⚠️ [ULTRA CRITICAL] 본문(content) 구성 주의사항
- **도입부 필수**: 본문 시작 시 바로 소제목(\`##\`)부터 나오지 마세요. 반드시 **글의 배경이나 흥미를 유발하는 도입 문단(Intro)**을 2~3문장 작성한 후 첫 번째 소제목을 시작하세요.
- **제목 중복 금지**: \`content\` 필드 내부에 제목(\`# 제목\`)을 다시 쓰지 마세요. 제목은 시스템이 별도로 처리합니다.
- **메타 정보 금지**: 아웃라인, 키워드, 태그 등을 \`content\` 필드에 텍스트로 포함하지 마세요. 오직 마크다운 본문만 들어갑니다.
- **목표 분량**: 약 ${Number(strategy.estimatedLength || 3000)}자
- **언어**: 100% 한국어 (영어 혼용 절대 금지)

## ✅ 최종 체크리스트 (하나라도 어길 시 실패)
- [ ] 본문이 흥미로운 도입 문단으로 시작하는가?
- [ ] 모든 소제목이 \`##\` (H2)로 작성되었는가? (볼드 처리 아님)
- [ ] 문단당 2~3문장으로 끊어져 있고, 문단 사이 빈 줄이 있는가?
- [ ] 표(Table)가 3열 이내이며 단답형으로 작성되었는가?
- [ ] 본문에 \`(매체명)\`이나 \`[뉴스]\` 같은 찌꺼기가 없는가?

## 📤 출력 형식 (순수 JSON)
\`\`\`json
{
  "title": "제목",
  "outline": ["소제목1", "소제목2", "소제목3", "소제목4", "소제목5"],
  "content": "본론 내용 (마크다운)",
  "metaTitle": "SEO 제목",
  "metaDescription": "SEO 설명",
  "focusKeywords": ["키워드1", "키워드2"],
  "references": [
     {"name": "뉴스 제목 (매체명)", "url": "URL"}
  ]
}
\`\`\`
`.trim();

  return `
${newsInstruction}
${strategicCore}
${layoutRules}
${mission}
`.trim();
}
