import { BlogPostInput, AutoPilotStrategy } from "../types/blog";
import { analyzeTopicIntent } from "../util/autoInference";

/**
 * [v3.34] Auto-Pilot 전용 정밀 프롬프트 엔진
 * - 헤딩(##) 마크다운 강제화 (NaverEditor 스타일 인식용)
 * - 모바일 호흡법 및 테이블 규격 동기화
 */
export function generateAutoPilotPrompt(input: BlogPostInput): string {
  const strategy = input.strategy as AutoPilotStrategy;
  if (!strategy) {
    throw new Error("Auto-Pilot 모드이나 전략 데이터가 누락되었습니다.");
  }

  // 1. 뉴스 및 실시간 정보 (Language Lock 적용)
  let newsInstruction = "";
  if (input.latestNews) {
    newsInstruction = `
# 📰 실시간 최신 정보 (2026년 2월 기준)
당신의 내장 지식보다 아래 정보를 최우선순위로 반영하세요.
- **언어 원칙**: 제공된 정보가 영어라도 **반드시 100% 한국어**로만 작성하세요.
- **출처 원칙**: 본문 내에 \`(매체명)\`, \`[뉴스]\`, \`[1]\` 등 어떠한 마커도 붙이지 마세요. (JSON references 필드에만 포함)
${input.latestNews}
`;
  }

  // 2. 오토파일럿 전략 및 페르소나 (Authority)
  const strategicCore = `
# 🎭 역할 및 전략 지침 (필수 준수)
당신은 분석된 경쟁사들의 장점을 흡수하고 단점을 보완하는 **전략적 작가**입니다.

${
  input.topic.includes("리스트")
    ? `
## 📋 [CRITICAL] 리스트 중심 구성 및 계층 구조(Depth) 지시
- 주제에 '리스트'가 포함되어 있습니다. 정보를 서술형 문단으로 쓰지 말고, 반드시 **계층이 구분된 마크다운 리스트(\`-\`)**로만 정리하세요.
- **🚨 콜론 사용 금지**: '브랜드명: 내용' 처럼 쓰지 말고, 하위 항목으로 들여쓰기하세요.
- **구조 예시**:
  - 편의점 브랜드명
    - 이벤트 카테고리
      - 세부 할인 혜택 (카드 정보 등)
      - 포함된 굿즈 리스트
- 본문의 핵심 데이터를 모두 리스트의 깊이(Depth)를 활용해 시각적으로 구조화하세요.
`
    : ""
}

## 1. 차별화 전략
${strategy.differentiationStrategy}

## 2. 세만틱 SEO 및 전문성 (New)
검색 엔진이 이 글을 '전문적인 문서'로 판단하도록 아래 연관어들을 본문에 자연스럽게 녹여내세요.
- **필수 연관 키워드**: ${input.keywords?.join(", ")}
- **전략**: 위 단어들을 단순히 나열하지 말고, 각 단어의 의미나 맥락을 설명하며 전문성을 드러내세요.

## 3. 문체 및 스타일 DNA
${strategy.styleDNA}
- **말투**: '해요체'를 절대 쓰지 마세요. 신뢰감을 주는 **'하십시오체' 또는 '평어체(-다)'**로 고정합니다.
- **정체**: AI임을 암시하거나 "전문가로서"와 같은 서술을 하지 마세요.

## 4. 구조 및 아웃라인
반드시 아래 5개 섹션을 충실히 채우세요:
${(strategy.suggestedOutline || []).join(" -> ")}
`.trim();

  // ✅ 3. 레이아웃 및 가독성 (Manual 모드와 동일한 엔진 적용)
  const layoutRules = `
# 🎨 레이아웃 및 포맷 규칙 (절대 준수)

## 📐 [CRITICAL] 헤딩(Heading) 및 소제목 규칙
이 규칙을 지키지 않으면 에디터 스타일이 적용되지 않습니다.
1. **마크다운 필수**: 모든 소제목(Outline 항목)은 반드시 **\`##\` (H2)** 또는 **\`###\` (H3)**를 사용하세요.
   - ❌ 나쁜 예: **1. 서론** (볼드 처리 금지)
   - ⭕ 좋은 예: ## 1. 서론
2. **구조 일치**: JSON의 \`outline\`에 있는 항목들은 본문에 반드시 \`##\` 헤딩으로 존재해야 합니다.

## 📱 [CRITICAL] 모바일 가독성 절대 규칙 (Mobile Breathing)
이 글은 100% 모바일 사용자가 읽습니다. **"벽돌 같은 텍스트(Wall of Text)"는 즉시 실패로 간주합니다.**
1. **호흡 끊기**:
   - 절대로 4문장 이상을 한 문단에 이어 쓰지 마세요.
   - **2~3문장(최대 150자)**이 모이면 무조건 줄을 바꾸세요.
   - 문단 사이에는 반드시 **빈 줄(Enter 2번)**을 넣어 시각적 여백을 확보하세요.
2. **단문 위주**: 접속사를 줄이고 문장을 짧게 끊어치세요.

## 📊 표(Table) 작성 규칙
${
  strategy.hasTable
    ? `
1. **필수 포함**: 전략상 표가 필요합니다. 반드시 1개 이상 작성하세요.
2. **규격 제한**: 모바일 폭을 고려하여 **최대 3열(Column)**까지만 사용하세요. (4열 금지)
3. **내용 제한**: 셀 안에는 "단답형 키워드(15자 이내)"만 넣으세요. 서술형 문장 금지.
`
    : "- 표는 꼭 필요한 비교/요약 시에만 사용하세요 (3열 이내)."
}

## ✨ 시각적 요소 및 강조
- **이미지 생성 금지**: 본문에 어떠한 이미지 관련 태그(\`![...]\`, \`[이미지:...]\`)도 **포함하지 마세요.**
- **컬러링 문법**: 강조(!!빨강!!), 긍정(++초록++), 주의(??주황??)를 적극 활용하세요.
`.trim();

  // 4. 작성 미션 및 체크리스트
  const mission = `
# 🎯 작성 미션
"${input.topic}" 주제로 포스트를 작성하세요.
- **목표 분량**: 약 ${strategy.estimatedLength || 3000}자
- **언어**: 100% 한국어 (영어 혼용 절대 금지)

## ✅ 최종 체크리스트 (하나라도 어길 시 실패)
- [ ] 모든 소제목이 \`##\` (H2)로 작성되었는가? (볼드 처리 아님)
- [ ] 문단당 2~3문장으로 끊어져 있고, 문단 사이 빈 줄이 있는가?
- [ ] 표(Table)가 3열 이내이며 단답형으로 작성되었는가?
- [ ] 본문에 \`(매체명)\`이나 \`[뉴스]\` 같은 찌꺼기가 없는가?
- [ ] 이미지 태그가 하나도 없는가?

## 📤 출력 형식 (순수 JSON)
\`\`\`json
{
  "title": "제목",
  "outline": ["소제목1", "소제목2", "소제목3", "소제목4", "소제목5"],
  "content": "본론 내용 (마크다운)",
  "metaTitle": "SEO 제목",
  "metaDescription": "SEO 설명",
  "focusKeywords": ["키워드1", "키워드2"],
  "references": [
     {"name": "뉴스 제목 (매체명)", "url": "URL"}
  ]
}
\`\`\`
`.trim();

  return `
${newsInstruction}
${strategicCore}
${layoutRules}
${mission}
`.trim();
}
