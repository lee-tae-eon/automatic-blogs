import { BaseAiClient } from "../ai";
import { BlogPostInput, AiGeneratedPost, Persona } from "../types/blog";
import { safeGenerate } from "../util/safeGenerate";

/**
 * ë©”ì¸ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ìƒì„± í•¨ìˆ˜
 */
export const generatePostSingleCall = async (
  client: BaseAiClient,
  input: BlogPostInput,
): Promise<AiGeneratedPost> => {
  let prompt;
  switch (input.persona) {
    case "empathetic":
      prompt = generateEmpatheticPrompt(input);
      break;
    case "experiential":
    case "storytelling":
    case "friendly":
    default:
      prompt = generateExperientialPrompt(input);
      break;
  }

  const response = await safeGenerate(async () => {
    return await client.generateJson<AiGeneratedPost>(prompt);
  });

  if (!response || !response.title) {
    throw new Error("AIê°€ ìœ íš¨í•œ JSON ë°ì´í„°ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
  }

  return response;
};

/**
 * ì²´í—˜í˜• í”„ë¡¬í”„íŠ¸ ìƒì„± (êµ¬. ì •ë³´ê³µìœ í˜•)
 */
function generateExperientialPrompt(input: BlogPostInput): string {
  const systemRole = `
# ì—­í•  ì •ì˜
ë‹¹ì‹ ì€ ìµœì‹  ì •ë³´ë¥¼ ì˜ ì •ë¦¬í•˜ì—¬ í•µì‹¬ë‚´ìš©ì„ ì „ë‹¬í•˜ëŠ” ì „ë¬¸ ë¸”ë¡œê±°ì…ë‹ˆë‹¤. ì •ë³´ì˜ ê¹Šì´ì™€ ì‹ ë¢°ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ì‚¬ëŒì´ ì§ì ‘ ì •ë¦¬í•œ ë“¯í•œ ê¸€ì„ ì”ë‹ˆë‹¤.
- ì‹œì : í˜„ì¬ ë‚ ì§œëŠ” ${new Date().toLocaleDateString()}ì…ë‹ˆë‹¤. ìµœì‹  ì •ë³´ë¥¼ ë°˜ì˜í•˜ì„¸ìš”.
- ì „ë¬¸ ë¶„ì•¼: ë…¼ë¦¬ì  êµ¬ì¡°, ë°ì´í„° ê¸°ë°˜ ë¶„ì„, ${input.topic} ì „ë¬¸ê°€.
- í•µì‹¬ ì›ì¹™: ê¸€ì˜ ë‚´ìš©ì€ í•µì‹¬ì„ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ëŒì´ ì½ê¸° ì¢‹ê²Œ(ê°€ë…ì„±) ì˜ ì„¸ë¶„í™” í•˜ì—¬ ì •ë¦¬í•˜ì—¬ì•¼ í•¨.
`;

  const contentStructure = `
# ì½˜í…ì¸  êµ¬ì¡° ë° ìŠ¤íƒ€ì¼ ê°€ì´ë“œ

## ğŸ“ ì†Œì œëª© ë° ë¬¸ë‹¨ êµ¬ì„± ê·œì¹™ (í•„ìˆ˜)
1. **ì†Œì œëª© ê°œìˆ˜**: ë°˜ë“œì‹œ **ì •í™•íˆ 5ê°œ**ì˜ ì†Œì œëª© ì„¹ì…˜ì„ ì‘ì„±í•˜ì„¸ìš”.
2. **ì†Œì œëª© í˜•ì‹ (ì¸ìš©êµ¬ ë¸”ë¡ ìµœì í™”)**:
   - ëª¨ë“  ì†Œì œëª©ì€ ë°˜ë“œì‹œ \`\\n> ## ì†Œì œëª©ëª…\` í˜•ì‹ì„ ì‚¬ìš©í•˜ì„¸ìš”.
   - **ì¤‘ìš”**: ì†Œì œëª© ì•ì—ëŠ” ì¤„ë°”ê¿ˆì„ **í•œ ë²ˆ(\\\\n)**ë§Œ ë„£ìœ¼ì„¸ìš”. (ê³¼ë„í•œ ìƒë‹¨ ê³µë°± ë°©ì§€)
   - ì†Œì œëª© ê¸°í˜¸(\`> ##\`)ì™€ í…ìŠ¤íŠ¸ ì‚¬ì´ì—ëŠ” ë°˜ë“œì‹œ **í•œ ì¹¸ì˜ ê³µë°±**ì„ ë‘ì„¸ìš”.
3. **ë¬¸ì¥ ê¸¸ì´ ì œí•œ**: ê° ì†Œì œëª© ì•„ë˜ì˜ ë³¸ë¬¸ ë¬¸ì¥ì€ **200ì ì´í•˜**ë¡œ ì§§ê²Œ ì‘ì„±í•˜ì„¸ìš”.
4. **ë¬¸ë‹¨ êµ¬ì„±**: 2~3ë¬¸ì¥ë§ˆë‹¤ ë¹ˆ ì¤„ì„ ì‚½ì…í•˜ì—¬ ëª¨ë°”ì¼ ê°€ë…ì„±ì„ ê·¹ëŒ€í™”í•˜ì„¸ìš”.

## ğŸ“ ë³¸ë¬¸ ë ˆì´ì•„ì›ƒ ì˜ˆì‹œ
---
> ## 1. ì²« ë²ˆì§¸ ì„¹ì…˜ ì œëª©
ë³¸ë¬¸ ë‚´ìš© ì‹œì‘...
---
`;

  const commonInstructions = `
## ğŸ¨ ì‹œê°ì  ìš”ì†Œ ë° SEO
- **ì´ëª¨ì§€**: ì†Œì œëª©ì— 1ê°œì”©ë§Œ ì‚¬ìš©. ë³¸ë¬¸ì—” ìµœì†Œí™”.
- **í‘œ(Table)**: ì •ë³´ê³µìœ í˜•ì´ë¯€ë¡œ ë¹„êµ ë¶„ì„ í‘œë¥¼ ë°˜ë“œì‹œ 1ê°œ ì´ìƒ í¬í•¨í•˜ì„¸ìš”.
- **ê°•ì¡°**: í•µì‹¬ í‚¤ì›Œë“œëŠ” **ë³¼ë“œì²˜ë¦¬**ë¥¼ í•˜ì„¸ìš”.
- **êµ¬ë¶„ì„ **: ê° ì†Œì œëª© ì„¹ì…˜ ìƒë‹¨ì— \`--- \`ë¥¼ ì‚½ì…í•˜ì„¸ìš”.
`;

  return `
${systemRole}
${contentStructure}
${commonInstructions}

# ğŸ¯ ì‘ì„± ë¯¸ì…˜
"${input.topic}" ì£¼ì œë¡œ ì •ë³´ê³µìœ í˜• í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

## ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ì†Œì œëª©ì€ ë°˜ë“œì‹œ 5ê°œì´ë©° \`\\n> ## ì†Œì œëª©\` í˜•ì‹ì„ ì² ì €íˆ ì§€í‚¬ ê²ƒ.
- [ ] ì†Œì œëª© ì¤„ì—ëŠ” ë‹¤ë¥¸ í…ìŠ¤íŠ¸ë¥¼ ì ˆëŒ€ ì„ì§€ ë§ ê²ƒ.

## ì¶œë ¥ í˜•ì‹ (ìˆœìˆ˜ JSONë§Œ)
{
  "title": "ì œëª©",
  "outline": ["ì†Œì œëª©1", "ì†Œì œëª©2", "ì†Œì œëª©3", "ì†Œì œëª©4", "ì†Œì œëª©5"],
  "content": "ë³¸ë¬¸ ë‚´ìš©",
  "metaTitle": "SEO ì œëª©",
  "metaDescription": "SEO ì„¤ëª…",
  "focusKeywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2"]
}

**ë°˜ë“œì‹œ ì§€í‚¬ ê²ƒ (ì†Œì œëª© ê·œì¹™)**
1. 'content' í•„ë“œ ë‚´ì—ì„œ ì†Œì œëª©ì„ ì‘ì„±í•  ë•Œ, ì†Œì œëª© ì‹œì‘ ì „ì—ëŠ” \`\\n\`ì„ ë„£ê³ , ì†Œì œëª© ì¢…ë£Œ í›„ì—ëŠ” **ì¤„ë°”ê¿ˆ ì—†ì´ ë°”ë¡œ ë‹¤ìŒ ë¬¸ì¥ì„ ì‹œì‘**í•˜ì„¸ìš”.
   ì˜ˆ: "...ì´ì „ ë‚´ìš©.\\n> ## ğŸ“Œ ìƒˆë¡œìš´ ì†Œì œëª©\\në‹¤ìŒ ë¬¸ë‹¨..."
2. ì¸ìš©êµ¬ ê¸°í˜¸(\`>\`) ë°”ë¡œ ë’¤ì— ì œëª© íƒœê·¸(\`##\`)ë¥¼ ë¶™ì—¬ì„œ ì‘ì„±í•˜ì„¸ìš”.
3. ì‘ë‹µì€ ì˜¤ì§ ìˆœìˆ˜í•œ JSON í˜•ì‹ë§Œ í—ˆìš©í•˜ë©°, ì¤„ë°”ê¿ˆì€ \`\\n\` ê¸°í˜¸ë¡œ ì²˜ë¦¬í•˜ì„¸ìš”.
`;
}
function generateEmpatheticPrompt(input: BlogPostInput): string {
  const systemRole = `
# ì—­í•  ì •ì˜
ë‹¹ì‹ ì€ ì§ì ‘ ê²½í—˜í•˜ê³  ëŠë‚€ ì ì„ ì˜ í‘œí˜„í•˜ëŠ” ì²´í—˜í˜• ë¸”ë¡œê±°ì…ë‹ˆë‹¤. ë‚´ê°€ ì§ì ‘ ì²´í—˜í•œ ìì—°ìŠ¤ëŸ¬ìš´ ê²½í—˜ ê¸°ë°˜ ìŠ¤í† ë¦¬í…”ë§ì„ êµ¬ì‚¬í•©ë‹ˆë‹¤.
- ì‹œì : í˜„ì¬ ë‚ ì§œ ${new Date().toLocaleDateString()} ê¸°ì¤€ ìµœì‹  ì •ë³´ë¥¼ ë°˜ì˜í•˜ì„¸ìš”.
- í•µì‹¬ ì›ì¹™: ì „ë¬¸ê°€ë¼ëŠ” ëŠë‚Œì„ ì£¼ì§€ ì•Šê³ , ê³µê°ê³¼ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ í•œ ìˆ˜í•„ í˜•ì‹ì„ ì§€í–¥í•©ë‹ˆë‹¤.
`;

  return `
${systemRole}

## ğŸ“ ì†Œì œëª© ë° ë¬¸ë‹¨ êµ¬ì„± ê·œì¹™ (í•„ìˆ˜)
1. **ì†Œì œëª© ê°œìˆ˜**: ë°˜ë“œì‹œ **ì •í™•íˆ 5ê°œ**ì˜ ì†Œì œëª© ì„¹ì…˜ì„ ì‘ì„±í•˜ì„¸ìš”.
2. **ì†Œì œëª© í˜•ì‹ (ì¸ìš©êµ¬ ë¸”ë¡ ìµœì í™”)**:
   - ëª¨ë“  ì†Œì œëª©ì€ ë°˜ë“œì‹œ \`\\n> ## ì†Œì œëª©ëª…\` í˜•ì‹ì„ ì‚¬ìš©í•˜ì„¸ìš”.
   - **ì¤‘ìš”**: ì†Œì œëª© ì•ì—ëŠ” ì¤„ë°”ê¿ˆì„ **í•œ ë²ˆ(\\\\n)**ë§Œ ë„£ìœ¼ì„¸ìš”. (ë¶ˆí•„ìš”í•œ ê³µë°± ë°©ì§€)
   - ì†Œì œëª© ê¸°í˜¸(\`> ##\`)ì™€ í…ìŠ¤íŠ¸ ì‚¬ì´ì—ëŠ” ë°˜ë“œì‹œ **í•œ ì¹¸ì˜ ê³µë°±**ì„ ë‘ì„¸ìš”.
3. **ë¬¸ì¥ ê¸¸ì´ ì œí•œ**: ê° ì†Œì œëª© ì•„ë˜ì˜ ë³¸ë¬¸ ë¬¸ì¥ì€ **200ì ì´í•˜**ë¡œ ì§§ê²Œ ì‘ì„±í•˜ì„¸ìš”.
4. **ë¬¸ë‹¨ êµ¬ì„±**: 2~3ë¬¸ì¥ë§ˆë‹¤ ë¹ˆ ì¤„ì„ ì‚½ì…í•˜ì—¬ ëª¨ë°”ì¼ ê°€ë…ì„±ì„ ê·¹ëŒ€í™”í•˜ì„¸ìš”.
5. **ì–´ì¡°**: "~í–ˆì–´ìš”", "~ë„¤ìš”" ë“± ì¹œê·¼í•˜ê³  ë‹¤ì •ë‹¤ê°í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.

# ğŸ¯ ì‘ì„± ë¯¸ì…˜
"${input.topic}" ì£¼ì œë¡œ ê³µê°í˜• í¬ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

## í•„ìˆ˜ ì¤€ìˆ˜ ì‚¬í•­
- [ ] ì†Œì œëª©ì€ ë°˜ë“œì‹œ 5ê°œ ì´ìƒì´ë©° \`\\n> ## ì†Œì œëª©\` í˜•ì‹ì„ ì² ì €íˆ ì§€í‚¬ ê²ƒ.
- [ ] ì‹¤ì œ ê²½í—˜ì´ ë¬»ì–´ë‚˜ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ì„œìˆ ì„ ì‚¬ìš©í•  ê²ƒ.
- [ ] í‘œ(Table) ì‚¬ìš© ê¸ˆì§€ (ê³µê°í˜•ì€ í…ìŠ¤íŠ¸ ì¤‘ì‹¬ì˜ ìŠ¤í† ë¦¬í…”ë§).

## ì¶œë ¥ í˜•ì‹ (ìˆœìˆ˜ JSONë§Œ)
{
  "title": "ì¹œê·¼í•œ ì œëª©",
  "outline": ["ì†Œì œëª©1", "ì†Œì œëª©2", "ì†Œì œëª©3", "ì†Œì œëª©4", "ì†Œì œëª©5"],
  "content": "ë³¸ë¬¸ ë‚´ìš©",
  "tags": ["íƒœê·¸1", "íƒœê·¸2"]
}

**ë°˜ë“œì‹œ ì§€í‚¬ ê²ƒ (ì†Œì œëª© ê·œì¹™)**
1. 'content' í•„ë“œ ë‚´ì—ì„œ ì†Œì œëª©ì„ ì‘ì„±í•  ë•Œ, ì†Œì œëª© ì‹œì‘ ì „ì—ëŠ” \`\\n\`ì„ ë„£ê³ , ì†Œì œëª© ì¢…ë£Œ í›„ì—ëŠ” **ì¤„ë°”ê¿ˆ ì—†ì´ ë°”ë¡œ ë‹¤ìŒ ë¬¸ì¥ì„ ì‹œì‘**í•˜ì„¸ìš”.
   ì˜ˆ: "...ì°¸ ì¢‹ë”ë¼ê³ ìš”.\\n> ## ğŸ˜Š ì†Œì œëª© ë‚´ìš©\\nì •ë§ ì¶”ì²œí•´ìš”..."
2. ì¸ìš©êµ¬ ê¸°í˜¸(\`>\`) ë°”ë¡œ ë’¤ì— ì œëª© íƒœê·¸(\`##\`)ë¥¼ ë¶™ì—¬ì„œ ì‘ì„±í•˜ì„¸ìš”.
3. ì‘ë‹µì€ ì˜¤ì§ ìˆœìˆ˜í•œ JSON í˜•ì‹ë§Œ í—ˆìš©í•˜ë©°, ì¤„ë°”ê¿ˆì€ \`\\n\` ê¸°í˜¸ë¡œ ì²˜ë¦¬í•˜ì„¸ìš”.
`;
}

/**
 * ìƒì„±ëœ ì½˜í…ì¸  í’ˆì§ˆ ê²€ì¦ ë¡œì§
 */
export const validatePostQuality = (
  post: AiGeneratedPost,
  input: BlogPostInput,
): { isValid: boolean; errors: string[] } => {
  const errors: string[] = [];

  // 1. ì†Œì œëª© ê°œìˆ˜ ë° í˜•ì‹ ê²€ì¦ (5ê°œ ê³ ì • ë° ì¸ìš©êµ¬ ë¬¸ë²• ì²´í¬)
  const quoteH2Count = (post.content.match(/^> ## /gm) || []).length;
  if (quoteH2Count !== 5) {
    errors.push(`ì†Œì œëª© ê°œìˆ˜ ì˜¤ë¥˜: ${quoteH2Count}ê°œ ë°œê²¬ (ë°˜ë“œì‹œ 5ê°œì—¬ì•¼ í•¨)`);
  }

  // 2. ë¬¸ì¥ ê¸¸ì´ ê²€ì¦ (ê°œë³„ ë¬¸ì¥ì´ 200ì ì´í•˜ì¸ì§€ ì²´í¬)
  const sentences = post.content.split(/[.!?]\s|\n/);
  for (const s of sentences) {
    if (s.trim().length > 200) {
      errors.push(`ë¬¸ì¥ ê¸¸ì´ ì´ˆê³¼: 200ìë¥¼ ë„˜ëŠ” ë¬¸ì¥ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      break;
    }
  }

  // 3. í˜ë¥´ì†Œë‚˜ë³„ í•„ìˆ˜ ìš”ì†Œ ê²€ì¦
  switch (input.persona) {
    case "experiential":
      if (!post.content.includes("|")) {
        errors.push("ì²´í—˜í˜•: ë¹„êµ í‘œê°€ ì—†ìŠµë‹ˆë‹¤.");
      }
      break;
    case "empathetic":
    case "storytelling":
    case "friendly":
      if (post.content.includes("|")) {
        errors.push(
          `${input.persona}: í‘œë¥¼ ì œê±°í•˜ê³  ì„œìˆ í˜•ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.`,
        );
      }
      break;
  }

  return {
    isValid: errors.length === 0,
    errors,
  };
};
