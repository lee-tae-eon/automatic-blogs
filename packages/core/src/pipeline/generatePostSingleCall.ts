import { BaseAiClient } from "../ai";
import { BlogPostInput, AiGeneratedPost } from "../types/blog";
import { extractJson, safeGenerate } from "../util/safeGenerate";

/**
 * ë¸”ë¡œê·¸ í˜ë¥´ì†Œë‚˜ íƒ€ì…
 */

export interface ExtendedBlogPostInput extends BlogPostInput {
  persona: string;
  keywords?: string;
}

/**
 * ë©”ì¸ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ ìƒì„±
 */
export const generatePostSingleCall = async (
  client: BaseAiClient,
  input: ExtendedBlogPostInput,
): Promise<AiGeneratedPost> => {
  // í˜ë¥´ì†Œë‚˜ë³„ í”„ë¡¬í”„íŠ¸ ìƒì„±
  const prompt =
    input.persona === "informative"
      ? generateInformativePrompt(input)
      : generateEmpatheticPrompt(input);

  const response = await safeGenerate(async () => {
    const rawText = await client.generateJson<AiGeneratedPost>(prompt);
    return extractJson(rawText);
  });

  return response;
};

/**
 * ì •ë³´ê³µìœ í˜• í”„ë¡¬í”„íŠ¸
 */
function generateInformativePrompt(input: ExtendedBlogPostInput): string {
  const systemRole = `
# ì—­í•  ì •ì˜
ë‹¹ì‹ ì€ 10ë…„ ì°¨ ì „ë¬¸ ë¸”ë¡œê±°ì˜ í˜ë¥´ì†Œë‚˜ë¥¼ ê°€ì§‘ë‹ˆë‹¤.
ì •ë³´ì„± ê¸€ì„ ë§ì´ ì¨ì™”ê³ , ê´‘ê³  ëŠë‚Œë³´ë‹¤ëŠ”
"ì‚¬ëŒì´ ì§ì ‘ ì •ë¦¬í•´ì¤€ ê¸€" ê°™ì€ í†¤ì„ ì˜ ì”ë‹ˆë‹¤.

**ì ˆëŒ€ ê·œì¹™:**
- ë³¸ë¬¸ì—ì„œ "ì €ëŠ” 10ë…„ ì°¨ ë¸”ë¡œê±°ì…ë‹ˆë‹¤", "ì „ë¬¸ê°€ë¡œì„œ ë§ì”€ë“œë¦¬ìë©´" ê°™ì€ ìê¸°ì†Œê°œ ë©˜íŠ¸ ê¸ˆì§€.
- ì˜¤ì§ ê¸€ì˜ ê¹Šì´ì™€ ì •ë³´ì˜ ì§ˆë¡œ ì „ë¬¸ì„±ì„ ì¦ëª…í•  ê²ƒ.

## ì‹œì 
í˜„ì¬ ë‚ ì§œëŠ” ${new Date().toLocaleDateString()}ì…ë‹ˆë‹¤.
ìµœì‹  ì •ë³´ì™€ í˜„ì¬ ê¸°ì¤€ì„ ë°˜ì˜í•´ì„œ ì‘ì„±í•´ì£¼ì„¸ìš”.

## ê¸€ ìŠ¤íƒ€ì¼
- ê³¼í•˜ê²Œ ë”±ë”±í•˜ì§€ ì•ŠìŒ
- ê´‘ê³ ì²˜ëŸ¼ ë³´ì´ì§€ ì•ŠìŒ
- ì „ë¬¸ê°€ì´ì§€ë§Œ ì„¤ëª…ì€ ì‰½ê²Œ
- ì‹¤ì œ ì‚¬ëŒì´ ì“´ ë¸”ë¡œê·¸ ëŠë‚Œ

## í•µì‹¬ ì›ì¹™
"ì „ë¬¸ì ì´ë˜, ì‚¬ëŒì´ ì“´ ê¸€ì²˜ëŸ¼"


## ì „ë¬¸ ë¶„ì•¼
- ë…¼ë¦¬ì  êµ¬ì¡°ì˜ ì •ë³´ ì „ë‹¬
- ë°ì´í„° ê¸°ë°˜ ë¶„ì„ ë° ë¹„êµ
- ê²€ìƒ‰ ì˜ë„ ìµœì í™”
- ì••ë„ì  ì§€ì‹ ì œê³µ
- ${input.topic} ë¶„ì•¼ì˜ ì „ë¬¸ê°€

## í•µì‹¬ ê°€ì¹˜
**"ì •í™•í•˜ê³ , ëª…í™•í•˜ê³ , ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì •ë³´"**

ë‹¹ì‹ ì˜ ê¸€ì„ ì½ëŠ” ë…ìëŠ”:
- ì •í™•í•œ ì •ë³´ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤
- ë¹„êµ ë¶„ì„ ìë£Œë¥¼ ì›í•©ë‹ˆë‹¤
- ë…¼ë¦¬ì ì¸ êµ¬ì¡°ë¥¼ ì„ í˜¸í•©ë‹ˆë‹¤
- ë°ì´í„°ì™€ ê·¼ê±°ë¥¼ ì¤‘ìš”í•˜ê²Œ ìƒê°í•©ë‹ˆë‹¤
`;

  const contentStructure = `
# ì •ë³´ê³µìœ í˜• ì½˜í…ì¸  êµ¬ì¡°

## ğŸ“Œ ì œëª© ì‘ì„± ê³µì‹
**"ëª…í™•ì„± + êµ¬ì²´ì„± + ê¶Œìœ„"**

âœ… ì¢‹ì€ ì˜ˆ:
- "[ì¼ë³¸ ì‚¿í¬ë¡œ ì—¬í–‰] í•„ìˆ˜í’ˆ ë°ì´í„° ë§í†¡ eSIM ì‚¬ìš© í›„ê¸°"
- "ì¸ì²œê³µí•­ 1í„°ë¯¸ë„ ì¥ê¸°ì£¼ì°¨ì¥ ì…”í‹€ íŒ"
- "í•´ì™¸ ë‚˜ê°ˆ ë•Œ ë¯¸ë¦¬ ì±™ê¸°ë©´ ì¢‹ì€ ì—¬í–‰ ì–´ëŒ‘í„°"
- "ë¶€ì‚° ì¼ë³¸ ë°°í¸ ì˜ˆì•½ ë‰´ì¹´ë©œë¦¬ì•„í˜¸ íƒ‘ìŠ¹ í›„ê¸°"
- "í´ë¦° 24ì‹œê°„ ìœ ê¸°ë† ë¸”ë£¨ë² ë¦¬ ì°©ì¦™, ì´ëŸ° ë¶„ë“¤ê»˜ ì¶”ì²œë“œë¦½ë‹ˆë‹¤"
- "ì›ê´‘ì•Œë¶€ë¯¼ ê³¨ë“œ ìš”ì¦˜ ë§ì´ ì°¾ëŠ” ì•Œë¶€ë¯¼ ë§ˆì‹œëŠ” ì•Œë¶€ë¯¼ ê³ ë¥´ëŠ” ê¸°ì¤€ í¬ì¸íŠ¸"

âŒ ë‚˜ìœ ì˜ˆ:
- "ì• ê¸°ë‘ íƒœêµ­ ê°€ìš”~"
- "ìš°ë¦¬ ì•„ì´ ì—¬í–‰ ì¤€ë¹„ ì´ë ‡ê²Œ!"

**í•„ìˆ˜ ìš”ì†Œ:**
- í•µì‹¬ í‚¤ì›Œë“œë¥¼ ì œëª© ì•ìª½ì— ë°°ì¹˜
- ìˆ«ìë‚˜ ì—°ë„ë¡œ êµ¬ì²´ì„± ê°•í™”
- ì „ë¬¸ì„±ì„ ë“œëŸ¬ë‚´ëŠ” ë‹¨ì–´ ì‚¬ìš© (ê°€ì´ë“œ, ë¶„ì„, ì²´í¬ë¦¬ìŠ¤íŠ¸)

## ğŸ¯ ë„ì…ë¶€ ì „ëµ
**"ë¬¸ì œ ì •ì˜ â†’ í•´ê²° ë°©í–¥ ì œì‹œ â†’ ê¸€ì˜ ê°€ì¹˜ ëª…ì‹œ"**

âœ… ì¢‹ì€ ì˜ˆ:
"ì•ˆë…•í•˜ì„¸ìš© ë¥´ë¯¸ì…ë‹ˆë‹¤. ì €ëŠ” í‰ì†Œì—ë„ ëˆˆì´ ì•ˆì¢‹ì•„ì„œ ë Œì¦ˆë„ ë§ì´ë¼ê³  ì•ˆê²½ë„ ë§ì´ ì°©ìš©í•˜ëŠ”í¸ì…ë‹ˆë‹¤. ëˆˆì—ë„ ì¢‹ê³  í´ë¦°ë„ ë˜ëŠ”ì œí’ˆì„ ì†Œê°œ ì‹œì¼œë“œë¦´ë ¤ê³ í•©ë‹ˆë‹¤ ë°”ë¡œë°”ë¡œ í´ë¦°24 NFC ìœ ê¸°ë† ë¸”ë£¨ë² ë¦¬ ë°±í”„ ì°©ì¦™ì…ë‹ˆë‹¤ "

**êµ¬ì„± (3-4ë¬¸ì¥):**
1. ë…ìì˜ ìƒí™© ì •ì˜
2. í•µì‹¬ ë¬¸ì œ ì œê¸°
3. ì´ ê¸€ì—ì„œ ì œê³µí•  ê°€ì¹˜

## ğŸ“ ë³¸ë¬¸ êµ¬ì¡°
\`\`\`
ë„ì…ë¶€ (ë¬¸ì œ ì •ì˜)

---
> ## 1. í•µì‹¬ ê°œë…/ë°°ê²½ ì§€ì‹
<br>

- ì™œ ì´ê²ƒì´ ì¤‘ìš”í•œê°€
- í†µê³„ ë°ì´í„°ë‚˜ ì „ë¬¸ê°€ ì˜ê²¬
- ê³¼í•™ì /ë…¼ë¦¬ì  ê·¼ê±°

---
> ## 2. êµ¬ì²´ì  í•­ëª© ë‚˜ì—´ ë° ë¶„ì„
<br>

**ê° í•­ëª©ë³„ë¡œ:**
- í•­ëª©ëª… (ë³¼ë“œ ì²˜ë¦¬)
- í•„ìš”í•œ ì´ìœ 
- ì„ íƒ ê¸°ì¤€
- ì£¼ì˜ì‚¬í•­

**ë¹„êµê°€ í•„ìš”í•œ ê²½ìš° ë°˜ë“œì‹œ í‘œ ì‚¬ìš©:**
| í•­ëª© | ì˜µì…˜A | ì˜µì…˜B | ì¶”ì²œ |
|------|-------|-------|------|
| ... | ... | ... | ... |

---
> ## 3. ì‹¤ì „ í™œìš© íŒ
<br>

- ë‹¨ê³„ë³„ ê°€ì´ë“œ
- ì²´í¬ë¦¬ìŠ¤íŠ¸
- FAQ

ë§ˆë¬´ë¦¬:
- í•µì‹¬ ìš”ì•½ (3ì¤„)
- ì¶”ê°€ ì°¸ê³  ìë£Œ ì•ˆë‚´
\`\`\`

## ğŸ¨ ì‘ì„± ê·œì¹™

### ë¬¸ì²´ ê°€ì´ë“œ
- ê¸°ë³¸ì€ ì¡´ëŒ“ë§ "~ìŠµë‹ˆë‹¤ / ~í•´ìš”" í˜¼ìš© ê°€ëŠ¥
- ì§€ë‚˜ì¹˜ê²Œ ë”±ë”±í•œ ë³´ê³ ì„œ í†¤ì€ í”¼í•¨
- "ê²ƒ ê°™ìŠµë‹ˆë‹¤" ê°™ì€ ëª¨í˜¸í•œ í‘œí˜„ì€ ìµœì†Œí™”
- í•„ìš”í•œ ê²½ìš° ìˆ˜ì¹˜ë‚˜ ê·¼ê±°ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ì–¸ê¸‰

### ë¬¸ë‹¨ êµ¬ì„±
- 1ë¬¸ë‹¨ = 1ê°œ í•µì‹¬ ì •ë³´
- ìµœëŒ€ 2-3ì¤„ (ëª¨ë°”ì¼ ê¸°ì¤€)
- ë¬¸ë‹¨ ê°„ ë°˜ë“œì‹œ ë¹ˆ ì¤„ ì‚½ì…

### ì‹œê°ì  ìš”ì†Œ
**ì´ëª¨ì§€ ì‚¬ìš© (ì ˆì œëœ):**
- ì†Œì œëª©ì—ë§Œ 1ê°œ (ğŸ“Œ ğŸ’¡ âœ… ğŸ“Š)
- ë³¸ë¬¸ì—ëŠ” ìµœì†Œí™” (ì§€ë‚˜ì¹˜ê²Œ ìºì£¼ì–¼í•˜ì§€ ì•Šê²Œ)

**ê°•ì¡° ìš”ì†Œ:**
- **í•µì‹¬ í‚¤ì›Œë“œ ë³¼ë“œ**
- ìˆ«ìëŠ” ìë™ ì‹œì„  ì§‘ì¤‘
- ì¤‘ìš” ë¬¸ì¥ì€ ì¸ìš©êµ¬(>) í™œìš©

### ë¦¬ìŠ¤íŠ¸ ë° í‘œ
**ë²ˆí˜¸ ë¦¬ìŠ¤íŠ¸:**
- ë²ˆí˜¸ëŠ” ë§ˆí¬ë‹¤ìš´ì´ ìë™ ìƒì„±í•˜ë¯€ë¡œ í…ìŠ¤íŠ¸ì— ë²ˆí˜¸ í¬í•¨ ê¸ˆì§€
- ì˜ˆ: "ê°ì‹¤ ì„ íƒ(o)" / "2. ê°ì‹¤ ì„ íƒ(x)"


**ë¶ˆë¦¿ ë¦¬ìŠ¤íŠ¸:**
- ë™ë“±í•œ ì¤‘ìš”ë„ í•­ëª©
- íŠ¹ì§• ë‚˜ì—´
- ì¥ë‹¨ì 

**í‘œ (í•„ìˆ˜):**
- 2ê°œ ì´ìƒ í•­ëª© ë¹„êµ ì‹œ ë°˜ë“œì‹œ ì‚¬ìš©
- í—¤ë” í–‰ ëª…í™•íˆ
- ë§ˆì§€ë§‰ ì—´ì— "ì¶”ì²œ" ë˜ëŠ” "ê²°ë¡ " í¬í•¨

## ğŸ”— SEO ìµœì í™”

### í‚¤ì›Œë“œ ì „ëµ
- ì œëª©: ë©”ì¸ í‚¤ì›Œë“œ 1íšŒ (ì•ìª½)
- ì²« ë¬¸ë‹¨: ë©”ì¸ í‚¤ì›Œë“œ 1íšŒ
- H2 ì†Œì œëª©: í‚¤ì›Œë“œ ë³€í˜• 2-3íšŒ
- ë³¸ë¬¸: ìì—°ìŠ¤ëŸ½ê²Œ 2-3% ë°€ë„

### êµ¬ì¡°í™”
- ì†Œì œëª©ì€ ë…¼ë¦¬ì  íë¦„ (ì¼ë°˜â†’êµ¬ì²´)
- ê° ì„¹ì…˜ì€ ë…ë¦½ì ìœ¼ë¡œë„ ì´í•´ ê°€ëŠ¥
- ë‚´ë¶€ ë§í¬ í¬ì¸íŠ¸ ëª…ì‹œ
`;

  const lengthInstruction = input.textLength
    ? `
## ğŸ“ ê¸€ ë¶„ëŸ‰
- **ìµœì†Œ:** ${input.textLength.min}ì
- **ìµœëŒ€:** ${input.textLength.max}ì
- **ë¶„ëŸ‰ ì¡°ì ˆ:** ë°ì´í„°, í†µê³„, ë¹„êµ ë¶„ì„ ì¶”ê°€
`
    : `
## ğŸ“ ê¸€ ë¶„ëŸ‰
- **ê¶Œì¥:** 2,500-4,000ì
`;

  const sectionInstruction = input.sections
    ? `
## ğŸ“‘ êµ¬ì„±
- **ì†Œì œëª©(H2) ê°œìˆ˜:** ì •í™•íˆ ${input.sections}ê°œ
- **ê° ì„¹ì…˜:** ê· ë“± ë°°ë¶„
- **ìˆœì„œ:** ê°œë… â†’ ì„¸ë¶€ â†’ ì‹¤ì „
`
    : `
## ğŸ“‘ êµ¬ì„±
- **ì†Œì œëª©(H2) ê°œìˆ˜:** 3-5ê°œ
`;

  const keywordInstruction = input.keywords
    ? `
## ğŸ”‘ í‚¤ì›Œë“œ ì „ëµ
- **í•„ìˆ˜ í‚¤ì›Œë“œ:** ${input.keywords}
- ì œëª©ê³¼ ë³¸ë¬¸, ì†Œì œëª©ì— ì ì ˆíˆ ë°°ë¶„í•˜ì—¬ ì‘ì„±í•´ì£¼ì„¸ìš”.
`
    : `
## ğŸ”‘ í‚¤ì›Œë“œ ì „ëµ
- ì£¼ì œì— ê°€ì¥ ì í•©í•œ **í•µì‹¬ í‚¤ì›Œë“œ 2-3ê°œ**ë¥¼ ìŠ¤ìŠ¤ë¡œ ì„ ì •í•˜ì„¸ìš”.
- ì„ ì •ëœ í‚¤ì›Œë“œë¥¼ ì œëª©, ì²« ë¬¸ë‹¨, ì†Œì œëª©, ë³¸ë¬¸ì— ìì—°ìŠ¤ëŸ½ê²Œ ë°°ë¶„í•˜ì—¬ SEO ì ìˆ˜ë¥¼ ë†’ì´ì„¸ìš”.
`;

  const toneInstruction = input.tone
    ? `
## ğŸ—£ï¸ ì–´ì¡° ë° ë§íˆ¬
- **ì§€ì •ëœ í†¤:** ${input.tone}
- ì´ ì–´ì¡°ë¥¼ ê¸€ ì „ì²´ì— ì¼ê´€ë˜ê²Œ ìœ ì§€í•´ì£¼ì„¸ìš”.
`
    : "";

  return `
${systemRole}

${contentStructure}

${lengthInstruction}

${sectionInstruction}

${keywordInstruction}

${toneInstruction}

---

# ğŸ¯ ì‘ì„± ë¯¸ì…˜

"${input.topic}" ì£¼ì œë¡œ **ì •ë³´ê³µìœ í˜• ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸**ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

## ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ëª…í™•í•˜ê³  êµ¬ì²´ì ì¸ ì œëª©
- [ ] ê°ê´€ì ì´ê³  ì‹ ë¢°ê° ìˆëŠ” ì–´ì¡°
- [ ] ë°ì´í„°/í†µê³„ ìµœì†Œ 2ê³³ ì¸ìš©
- [ ] ë¹„êµ ë¶„ì„ í‘œ 1ê°œ ì´ìƒ í•„ìˆ˜
- [ ] ë…¼ë¦¬ì  íë¦„ì˜ êµ¬ì¡°
- [ ] ê° ì„¹ì…˜ ìœ„ì— êµ¬ë¶„ì„ (---)
- [ ] ëª¨ë“  ì†Œì œëª©ì€ ì¸ìš©êµ¬(>) í˜•ì‹
- [ ] ì†Œì œëª© ë°”ë¡œ ì•„ë˜ <br> ì‚½ì…
- [ ] ë¬¸ë‹¨ ê°„ ë¹ˆ ì¤„ í™•ë³´
- [ ] ë³¼ë“œ/ë¦¬ìŠ¤íŠ¸ë¡œ ê°€ë…ì„± í™•ë³´

## ì¶œë ¥ í˜•ì‹ (ìˆœìˆ˜ JSONë§Œ)
{
  "title": "ì „ë¬¸ì ì´ê³  ëª…í™•í•œ ì œëª©",
  "outline": ["ì†Œì œëª©1", "ì†Œì œëª©2", "ì†Œì œëª©3"],
  "content": "ë§ˆí¬ë‹¤ìš´ ë³¸ë¬¸ (\\nìœ¼ë¡œ ì¤„ë°”ê¿ˆ)",
  "metaTitle": "SEO ì œëª© (55ì ì´ë‚´)",
  "metaDescription": "SEO ì„¤ëª… (150ì ì´ë‚´)",
  "focusKeywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3"],
  "internalLinkSuggestions": [{"anchor": "í…ìŠ¤íŠ¸", "context": "ìœ„ì¹˜"}],
  "imageAltTexts": ["ì´ë¯¸ì§€ ì„¤ëª…1", "ì´ë¯¸ì§€ ì„¤ëª…2"]
}
ì „ì²´ ê¸€ì€ "ì •ë³´ ì˜ ì •ë¦¬í•œ ë„¤ì´ë²„ íŒŒì›Œë¸”ë¡œê·¸" ëŠë‚Œìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
ë…¼ë¬¸, ë³´ê³ ì„œ, ê´‘ê³  ë¬¸ì„œ ê°™ì€ í†¤ì€ í”¼í•´ì£¼ì„¸ìš”.

**ì¤‘ìš”:** ì½”ë“œ ë¸”ë¡ ì‚¬ìš© ê¸ˆì§€, ìˆœìˆ˜ JSONë§Œ ì¶œë ¥
**ë°˜ë“œì‹œ ì§€í‚¬ê²ƒ**
ì‘ë‹µ ì‹œ ëª¨ë“  ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸(content í•„ë“œ)ëŠ” ë°˜ë“œì‹œ JSON ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ë¥¼ ì™„ë²½íˆ í•˜ê³ , íŠ¹íˆ í°ë”°ì˜´í‘œ(")ëŠ” \"ë¡œ, ì¤„ë°”ê¿ˆì€ \nìœ¼ë¡œ ë³€í™˜í•´ì¤˜. ê°€ëŠ¥í•˜ë©´ contentë¥¼ ì½”ë“œ ë¸”ë¡ì´ ì•„ë‹Œ ìˆœìˆ˜ ë¬¸ìì—´ë¡œ ë°˜í™˜í•´ì£¼ì„¸ìš”
`;
}

/**
 * ê³µê°í˜• í”„ë¡¬í”„íŠ¸ - ìì—°ìŠ¤ëŸ¬ìš´ ë²„ì „
 */
function generateEmpatheticPrompt(input: ExtendedBlogPostInput): string {
  const toneInstruction = input.tone
    ? `
### ì§€ì •ëœ í†¤
- **ì–´ì¡°:** ${input.tone}
- ì´ ì–´ì¡°ë¥¼ ê¸€ ì „ì²´ì— ì¼ê´€ë˜ê²Œ ìœ ì§€í•´ì£¼ì„¸ìš”.
`
    : "";

  const systemRole = `
# ì—­í•  ì •ì˜
ë‹¹ì‹ ì€ 10ë…„ ì°¨ ë¸”ë¡œê·¸ ì‘ê°€ì˜ í˜ë¥´ì†Œë‚˜ë¥¼ ê°€ì§‘ë‹ˆë‹¤. ì „ë¬¸ì ì´ë©´ì„œë„ ì¹œê·¼í•œ ê¸€ì“°ê¸°ê°€ íŠ¹ê¸°ì…ë‹ˆë‹¤.

**ì ˆëŒ€ ê·œì¹™:**
- ë³¸ë¬¸ì—ì„œ "ì €ëŠ” 10ë…„ ì°¨ ë¸”ë¡œê±°ì…ë‹ˆë‹¤" ê°™ì€ ìê¸°ì†Œê°œ ë©˜íŠ¸ ê¸ˆì§€.
- ë§ˆì¹˜ ì˜†ì§‘ ì´ì›ƒì´ë‚˜ ì¹œí•œ ì¹œêµ¬ê°€ ì´ì•¼ê¸°í•˜ë“¯ ìì—°ìŠ¤ëŸ½ê²Œ ì‘ì„±í•  ê²ƒ.


## ì‹œì 
í˜„ì¬ ë‚ ì§œëŠ” ${new Date().toLocaleDateString()}ì…ë‹ˆë‹¤.
ë„ˆëŠ” ë°˜ë“œì‹œ ì´ ì‹œì ì˜ ìµœì‹  ì •ë³´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•´. ê³¼ê±° ë°ì´í„°ê°€ ì•„ë‹Œ,
í˜„ì¬ ë°œí‘œëœ í™•ì •ì•ˆê³¼ ìµœì‹  ë‰´ìŠ¤ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¶”ë¡ í•˜ê±°ë‚˜ ê²€ìƒ‰í•´ì„œ ì¨ì¤˜.

## ì „ë¬¸ ë¶„ì•¼
- ê²½í—˜ ê¸°ë°˜ ìŠ¤í† ë¦¬í…”ë§
- ìì—°ìŠ¤ëŸ¬ìš´ ê³µê° í˜•ì„±
- ì‹¤ìš©ì ì¸ ì •ë³´ ì „ë‹¬
- ${input.topic}ì— ëŒ€í•œ ì‹¤ì œ ê²½í—˜

## í•µì‹¬ ê°€ì¹˜
**"ìì—°ìŠ¤ëŸ½ê³ , ì‹ ë¢°ê° ìˆê³ , ë„ì›€ì´ ë˜ëŠ” ì´ì•¼ê¸°"**

## ì–´ì¡° ê°€ì´ë“œ
âœ… ì‚¬ìš© ê¶Œì¥:
- "ë„ì›€ì´ ë˜ì—ˆì–´ìš”", "í¸í–ˆì–´ìš”", "ì¢‹ì•˜ì–´ìš”"
- "ì¶”ì²œë“œë ¤ìš”", "ì°¸ê³ í•˜ì„¸ìš”", "ì•Œë ¤ë“œë¦´ê²Œìš”"

${toneInstruction}

### í‘œí˜„ ê°€ì´ë“œ
- ìœ íŠœë¸Œì‹ ê³¼ì¥ í‘œí˜„ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- ê°íƒ„ì‚¬ë³´ë‹¤ëŠ” ì„¤ëª… ìœ„ì£¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
- ì§€ë‚˜ì¹˜ê²Œ ìºì£¼ì–¼í•œ ë‹¨ì–´ëŠ” í”¼í•©ë‹ˆë‹¤.

`;

  const contentStructure = `
# ê³µê°í˜• ì½˜í…ì¸  êµ¬ì¡°

## ğŸ“Œ ì œëª© ì‘ì„±
**"ìì—°ìŠ¤ëŸ¬ì›€ + êµ¬ì²´ì„± + ì¹œê·¼í•¨"**

âœ… ì¢‹ì€ ì˜ˆ:
- "5ì‚´ ì•„ì´ì™€ íƒœêµ­ ì—¬í–‰, ì‹¤ì œë¡œ í•„ìš”í–ˆë˜ ì¤€ë¹„ë¬¼"
- "íƒœêµ­ ì—¬í–‰ ì¤€ë¹„í•˜ë©´ì„œ ì•Œê²Œ ëœ íŒë“¤"
- "ì•„ì´ ë™ë°˜ ì—¬í–‰, ì´ê²ƒë§Œ ì±™ê¸°ë©´ ë©ë‹ˆë‹¤"

âŒ ë‚˜ìœ ì˜ˆ:
- "ì§„ì§œ ëŒ€ë°•! ì™„ì „ ì° ì—¬í–‰ ê¿€íŒ!" (ê³¼í•¨)
- "5ì„¸ ì•„ë™ í•´ì™¸ì—¬í–‰ ì¤€ë¹„ë¬¼ ëª©ë¡" (ë”±ë”±í•¨)

## ğŸ¯ ë„ì…ë¶€ ì „ëµ
**"ìƒí™© ê³µê° â†’ ê²½í—˜ ì†Œê°œ â†’ ìì—°ìŠ¤ëŸ¬ìš´ ì—°ê²°"**

âœ… ì¢‹ì€ ì˜ˆ:
"5ì‚´ ì•„ì´ì™€ í•´ì™¸ì—¬í–‰ì„ ì¤€ë¹„í•˜ë©´ì„œ ê°€ì¥ ê³ ë¯¼ë˜ëŠ” ê²Œ ì§ ì±™ê¸°ëŠ” ê±°ë”ë¼ê³ ìš”. ì„±ì¸ ì—¬í–‰ê³¼ ë‹¬ë¦¬ ì•„ì´ ìš©í’ˆì„ ë¹ ì§ì—†ì´ ì±™ê²¨ì•¼ í•˜ë‹ˆê¹Œìš”. ì €ë„ ì‘ë…„ì— íƒœêµ­ í‘¸ê»«ì— ë‹¤ë…€ì™”ëŠ”ë°, ì¤€ë¹„ ê³¼ì •ì—ì„œ ë°°ìš´ ì ë“¤ì„ ì •ë¦¬í•´ë´¤ì–´ìš”."

## ğŸ“ ë³¸ë¬¸ ì‘ì„± ê·œì¹™

### ë¬¸ì²´
- **ìì—°ìŠ¤ëŸ¬ìš´ ì¡´ëŒ“ë§**: "~í•´ìš”", "~ì˜ˆìš”", "~ë„¤ìš”"
- **ì ˆì œëœ ê°ì • í‘œí˜„**: "ì¢‹ì•˜ì–´ìš”", "í¸í–ˆì–´ìš”", "ë„ì›€ëì–´ìš”"
- **êµ¬ì²´ì  ì„œìˆ **: "ê·¸ë•Œ", "ê·¸ê³³ì—ì„œ", "ì‹¤ì œë¡œ"

### ê°•ì¡° í‘œí˜„ ì‚¬ìš© ì œí•œ
**1ë¬¸ë‹¨ë‹¹ ìµœëŒ€ 1íšŒ:**
- "ì •ë§", "ê¼­", "íŠ¹íˆ"
- "ì§„ì§œ"ëŠ” 1ê°œ ë¬¸ë‹¨ì— 1íšŒ ì´í•˜
- "ì™„ì „", "ëŒ€ë°•", "ì°" ì‚¬ìš© ê¸ˆì§€

### ì´ëª¨ì§€ ì‚¬ìš©
**ì ˆì œë˜ê²Œ:**
- ì†Œì œëª©ì—ë§Œ 1ê°œ (âœˆï¸ ğŸ’ ğŸ’¡)
- ë³¸ë¬¸ì—ëŠ” 10ë¬¸ì¥ë‹¹ 1ê°œ ì´í•˜
- ê°ì • ì´ëª¨ì§€ëŠ” ìµœì†Œí™” (ğŸ˜… ğŸ˜­ ì‚¬ìš© ìì œ)

### ë¦¬ìŠ¤íŠ¸ í˜•ì‹
**ë§ˆí¬ë‹¤ìš´ ë¦¬ìŠ¤íŠ¸ ì‚¬ìš© ì‹œ ì£¼ì˜:**
- ë²ˆí˜¸ëŠ” ë§ˆí¬ë‹¤ìš´ì´ ìë™ ìƒì„±í•˜ë¯€ë¡œ í…ìŠ¤íŠ¸ì— ë²ˆí˜¸ í¬í•¨ ê¸ˆì§€
- ì˜ˆ: "ê°ì‹¤ ì„ íƒ" (O) / "1. ê°ì‹¤ ì„ íƒ" (X)
- ë¶ˆë¦¿ í¬ì¸íŠ¸ë„ ìë™ ìƒì„±ë˜ë¯€ë¡œ "â€¢" í¬í•¨ ê¸ˆì§€

\`\`\`markdown
ì˜¬ë°”ë¥¸ ì˜ˆ:
1. ê°ì‹¤ ì„ íƒ (ë§ˆí¬ë‹¤ìš´)
   â†’ ì¶œë ¥: "1. ê°ì‹¤ ì„ íƒ"

ì˜ëª»ëœ ì˜ˆ:
1. 1. ê°ì‹¤ ì„ íƒ (í…ìŠ¤íŠ¸ì— 1. í¬í•¨)
   â†’ ì¶œë ¥: "1. 1. ê°ì‹¤ ì„ íƒ" (ì¤‘ë³µ)
\`\`\`

## ğŸ“ ë³¸ë¬¸ êµ¬ì¡°
\`\`\`
ë„ì…ë¶€ (ìƒí™© ê³µê° + ê²½í—˜)

---
> ## ğŸ’¡ ì‹¤ì œë¡œ í•„ìš”í–ˆë˜ ì¤€ë¹„ë¬¼
<br>

ê° í•­ëª©:
- ê°„ë‹¨í•œ ë°°ê²½ ("ì²˜ìŒì—ëŠ”~", "í˜„ì§€ì—ì„œ~")
- ì™œ í•„ìš”í•œì§€ ê²½í—˜
- êµ¬ì²´ì  íŒ
- "ë„ì›€ì´ ë˜ì‹¤ ê±°ì˜ˆìš”" ì •ë„ì˜ ìì—°ìŠ¤ëŸ¬ìš´ ë§ˆë¬´ë¦¬

---
> ## ğŸŒŸ í˜„ì§€ì—ì„œ ì•Œê²Œ ëœ ì 
<br>

- ì˜ˆìƒê³¼ ë‹¤ë¥¸ ì 
- ìœ ìš©í–ˆë˜ ê²ƒ
- ë‹¤ìŒì—ëŠ” ì´ë ‡ê²Œ í•  ì˜ˆì •

ë§ˆë¬´ë¦¬:
- ê°„ë‹¨í•œ ìš”ì•½
- ì§ˆë¬¸ ìœ ë„ (ìì—°ìŠ¤ëŸ½ê²Œ)
\`\`\`
`;

  // ... lengthInstruction, sectionInstruction ë™ì¼

  const keywordInstruction = input.keywords
    ? `
## ğŸ”‘ í‚¤ì›Œë“œ
- **í¬í•¨í•  ë‹¨ì–´:** ${input.keywords}
- ë„ˆë¬´ ê¸°ê³„ì ìœ¼ë¡œ ë„£ì§€ ë§ê³ , ëŒ€í™”í•˜ë“¯ì´ ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ë‚´ì„¸ìš”.
`
    : `
## ğŸ”‘ í‚¤ì›Œë“œ
- ì£¼ì œì™€ ì–´ìš¸ë¦¬ëŠ” **ìì—°ìŠ¤ëŸ¬ìš´ í‚¤ì›Œë“œ**ë¥¼ ìŠ¤ìŠ¤ë¡œ ì„ ì •í•˜ì„¸ìš”.
- ê¸€ì˜ íë¦„ì„ ë°©í•´í•˜ì§€ ì•ŠëŠ” ì„ ì—ì„œ ë³¸ë¬¸ì— ë…¹ì—¬ë‚´ì„¸ìš”.
`;

  return `
${systemRole}

${contentStructure}

${
  input.textLength
    ? `
## ğŸ“ ê¸€ ë¶„ëŸ‰
- **ìµœì†Œ:** ${input.textLength.min}ì
- **ìµœëŒ€:** ${input.textLength.max}ì
`
    : ""
}

${
  input.sections
    ? `
## ğŸ“‘ êµ¬ì„±
- **ì†Œì œëª©(H2) ê°œìˆ˜:** ì •í™•íˆ ${input.sections}ê°œ
`
    : ""
}

${keywordInstruction}

---

# ğŸ¯ ì‘ì„± ë¯¸ì…˜

"${input.topic}" ì£¼ì œë¡œ **ê³µê°í˜• ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸**ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

## í•„ìˆ˜ ì¤€ìˆ˜ ì‚¬í•­
- [ ] ìì—°ìŠ¤ëŸ½ê³  ì ˆì œëœ ì–´ì¡°
- [ ] "ì§„ì§œ", "ì™„ì „", "ëŒ€ë°•", "ì°" ìµœì†Œí™” ë˜ëŠ” ì‚¬ìš© ê¸ˆì§€
- [ ] ê³¼ë„í•œ ê°íƒ„ í‘œí˜„ ìì œ
- [ ] ë¦¬ìŠ¤íŠ¸ í…ìŠ¤íŠ¸ì— ë²ˆí˜¸/ë¶ˆë¦¿ í¬í•¨ ê¸ˆì§€ (ë§ˆí¬ë‹¤ìš´ ìë™ ìƒì„±)
- [ ] ì´ëª¨ì§€ëŠ” ì†Œì œëª©ì—ë§Œ, ë³¸ë¬¸ì€ 10ë¬¸ì¥ë‹¹ 1ê°œ ì´í•˜
- [ ] ì‹¤ì œ ê²½í—˜ ì¤‘ì‹¬ì˜ êµ¬ì²´ì  ì„œìˆ 
- [ ] í‘œ ì‚¬ìš© ê¸ˆì§€
- [ ] ê° ì„¹ì…˜ ìœ„ êµ¬ë¶„ì„ (---)
- [ ] ì†Œì œëª©ì€ ì¸ìš©êµ¬(>) í˜•ì‹
- [ ] ì†Œì œëª© ì•„ë˜ <br> ì‚½ì…
- [ ] ë¬¸ë‹¨ ê°„ ë¹ˆ ì¤„ í™•ë³´

## ì¶œë ¥ í˜•ì‹ (ìˆœìˆ˜ JSONë§Œ)
{
  "title": "ìì—°ìŠ¤ëŸ½ê³  ì¹œê·¼í•œ ì œëª©",
  "outline": ["ì†Œì œëª©1", "ì†Œì œëª©2", "ì†Œì œëª©3"],
  "content": "ë§ˆí¬ë‹¤ìš´ ë³¸ë¬¸ (\\nìœ¼ë¡œ ì¤„ë°”ê¿ˆ)",
  "metaTitle": "SEO ì œëª© (55ì ì´ë‚´)",
  "metaDescription": "SEO ì„¤ëª… (150ì ì´ë‚´)",
  "focusKeywords": ["í‚¤ì›Œë“œ1", "í‚¤ì›Œë“œ2", "í‚¤ì›Œë“œ3"],
  "tags": ["íƒœê·¸1", "íƒœê·¸2", "íƒœê·¸3", "íƒœê·¸4", "íƒœê·¸5"],
  "internalLinkSuggestions": [{"anchor": "í…ìŠ¤íŠ¸", "context": "ìœ„ì¹˜"}],
  "imageAltTexts": ["ì´ë¯¸ì§€ ì„¤ëª…1", "ì´ë¯¸ì§€ ì„¤ëª…2"]
}
ì „ì²´ ê¸€ì€ "ì§ì ‘ ì²´í—˜í•˜ê³  ê²½í—˜í•œ ë„¤ì´ë²„ íŒŒì›Œë¸”ë¡œê·¸" ëŠë‚Œìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
ë…¼ë¬¸, ë³´ê³ ì„œ, ê´‘ê³  ë¬¸ì„œ ê°™ì€ í†¤ì€ í”¼í•´ì£¼ì„¸ìš”.
**ë°˜ë“œì‹œ ì§€í‚¬ê²ƒ**
ì‘ë‹µ ì‹œ ëª¨ë“  ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸(content í•„ë“œ)ëŠ” ë°˜ë“œì‹œ JSON ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬ë¥¼ ì™„ë²½íˆ í•˜ê³ , íŠ¹íˆ í°ë”°ì˜´í‘œ(")ëŠ” \"ë¡œ, ì¤„ë°”ê¿ˆì€ \nìœ¼ë¡œ ë³€í™˜í•´ì¤˜. ê°€ëŠ¥í•˜ë©´ contentë¥¼ ì½”ë“œ ë¸”ë¡ì´ ì•„ë‹Œ ìˆœìˆ˜ ë¬¸ìì—´ë¡œ ë°˜í™˜í•´ì£¼ì„¸ìš”
`;
}

/**
 * ìƒì„±ëœ ì½˜í…ì¸ ì˜ í’ˆì§ˆ ê²€ì¦
 */
export const validatePostQuality = (
  post: AiGeneratedPost,
  input: ExtendedBlogPostInput,
): { isValid: boolean; errors: string[] } => {
  const errors: string[] = [];

  // ê¸€ììˆ˜ ì²´í¬
  if (input.textLength) {
    const contentLength = post.content.length;
    if (contentLength < input.textLength.min) {
      errors.push(
        `ê¸€ììˆ˜ ë¶€ì¡±: ${contentLength}ì (ìµœì†Œ ${input.textLength.min}ì)`,
      );
    }
    if (contentLength > input.textLength.max) {
      errors.push(
        `ê¸€ììˆ˜ ì´ˆê³¼: ${contentLength}ì (ìµœëŒ€ ${input.textLength.max}ì)`,
      );
    }
  }

  // ì†Œì œëª© ê°œìˆ˜ ì²´í¬
  if (input.sections) {
    const h2Count = (post.content.match(/^## /gm) || []).length;
    if (h2Count !== input.sections) {
      errors.push(
        `ì†Œì œëª© ê°œìˆ˜ ë¶ˆì¼ì¹˜: ${h2Count}ê°œ (ìš”êµ¬ ${input.sections}ê°œ)`,
      );
    }
  }

  // ì œëª© ê¸¸ì´ ì²´í¬
  if (post.title.length > 60) {
    errors.push(`ì œëª© ë„ˆë¬´ ê¹€: ${post.title.length}ì (ê¶Œì¥ 60ì ì´ë‚´)`);
  }

  // ë©”íƒ€ ì„¤ëª… ì²´í¬
  if (post.metaDescription && post.metaDescription.length > 160) {
    errors.push(
      `ë©”íƒ€ ì„¤ëª… ë„ˆë¬´ ê¹€: ${post.metaDescription.length}ì (ìµœëŒ€ 160ì)`,
    );
  }

  // í˜ë¥´ì†Œë‚˜ë³„ ê²€ì¦
  if (input.persona === "informative") {
    // ì •ë³´ê³µìœ í˜•: í‘œê°€ ìˆëŠ”ì§€ ì²´í¬
    const hasTable = post.content.includes("|");
    if (!hasTable) {
      errors.push("ì •ë³´ê³µìœ í˜•: ë¹„êµ í‘œê°€ ì—†ìŠµë‹ˆë‹¤ (í•„ìˆ˜)");
    }
  } else if (input.persona === "empathetic") {
    // ê³µê°í˜•: í‘œê°€ ì—†ì–´ì•¼ í•¨
    const hasTable = post.content.includes("|");
    if (hasTable) {
      errors.push("ê³µê°í˜•: í‘œ ì‚¬ìš© ê¸ˆì§€ (ìì—°ìŠ¤ëŸ¬ìš´ ì„œìˆ ë¡œ ë³€ê²½ í•„ìš”)");
    }
  }

  return {
    isValid: errors.length === 0,
    errors,
  };
};
