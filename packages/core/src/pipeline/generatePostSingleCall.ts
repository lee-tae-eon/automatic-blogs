import { BaseAiClient } from "../ai";
import { BlogPostInput, AiGeneratedPost } from "../types/blog";
import { safeGenerate } from "../util/safeGenerate";

export const generatePostSingleCall = async (
  client: BaseAiClient,
  input: BlogPostInput,
): Promise<AiGeneratedPost> => {
  const role = `
ë„ˆëŠ” ë¸”ë¡œê·¸ ìƒìœ„ ë…¸ì¶œì„ ì „ë¬¸ìœ¼ë¡œ í•˜ëŠ” ì½˜í…ì¸  ì „ëžµê°€ë‹¤.
ê²€ìƒ‰ ì˜ë„ë¥¼ ì •í™•ížˆ ë°˜ì˜í•˜ê³ ,
ë¶ˆí•„ìš”í•œ ìˆ˜ì‹ì–´ëŠ” ì¤„ì´ë©°,
ì‹¤ì œ ê²€ìƒ‰ ì‚¬ìš©ìžì—ê²Œ ë„ì›€ì´ ë˜ëŠ” ì •ë³´ë§Œ ìž‘ì„±í•œë‹¤.
 ë…ìžê°€ ëê¹Œì§€ ì½ê²Œ ë§Œë“œëŠ” ëª°ìž…ê° ìžˆëŠ” ë¬¸ì²´ì™€, ê²€ìƒ‰ ì—”ì§„ì— ìµœì í™”ëœ(SEO) êµ¬ì¡°ë¡œ ê¸€ì„ ì“°ëŠ” ë° ì²œìž¬ì ì´ì•¼.
 ì ì ˆí•œ ì´ëª¨ì§€ì™€ ê°€ë…ì„± ë†’ì€ ë¬¸ë‹¨ êµ¬ì„±ì„ í†µí•´ ì‹œê°ì ìœ¼ë¡œ ë§¤ë ¥ì ì¸ ê¸€ì„ ìž‘ì„±í•œë‹¤.
`;

  const toneInstruction = input.tone
    ? `ë§íˆ¬ëŠ” "${input.tone}" ìŠ¤íƒ€ì¼ë¡œ ìž‘ì„±í•œë‹¤.`
    : "";

  const lengthInstruction = input.textLength
    ? `
[ê¸€ ë¶„ëŸ‰ ì¡°ê±´]
- ìµœì¢… ê²°ê³¼ë¬¼ì€ ê³µë°± í¬í•¨ ${input.textLength.min}ìž ì´ìƒ ${input.textLength.max}ìž ì´í•˜ë¡œ ìž‘ì„±í•œë‹¤.
- ì´ ì¡°ê±´ì€ ë°˜ë“œì‹œ ì§€í‚¨ë‹¤.
`
    : "";

  const sectionInstruction = input.sections
    ? `ì†Œì œëª© ê°œìˆ˜ëŠ” ì •í™•ížˆ ${input.sections}ê°œë¡œ êµ¬ì„±í•œë‹¤.`
    : "";

  const prompt = `
${role}

[ì£¼ì œ]
"${input.topic}"

${toneInstruction}
${lengthInstruction}
${sectionInstruction}

[ìž‘ì„± ê·œì¹™]
- **ì´ëª¨ì§€ í•„ìˆ˜ ì‚¬ìš©**: ì œëª©, ì†Œì œëª©, ê·¸ë¦¬ê³  ê° ë¬¸ë‹¨ì˜ ì²« ì‹œìž‘ì´ë‚˜ ê°•ì¡°í•  ë•Œ ì´ëª¨ì§€(âœ¨, ðŸ’¡, âœˆï¸, ðŸŽ’, âœ… ë“±)ë¥¼ í’ë¶€í•˜ê²Œ ì‚¬ìš©í•˜ì—¬ ì‹œê°ì ì¸ ì¦ê±°ì›€ì„ ì¤€ë‹¤. ìµœì†Œ 5ë¬¸ìž¥ë§ˆë‹¤ 1ê°œ ì´ìƒì˜ ì´ëª¨ì§€ë¥¼ í¬í•¨í•  ê²ƒ.
- **ë¬¸ë‹¨ ë° ê°€ë…ì„±**:
  - í•œ ë¬¸ë‹¨ì€ ìµœëŒ€ 3ì¤„ì„ ë„˜ê¸°ì§€ ì•ŠëŠ”ë‹¤.
  - ë¬¸ë‹¨ê³¼ ë¬¸ë‹¨ ì‚¬ì´ëŠ” í™•ì‹¤í•˜ê²Œ ì¤„ë°”ê¿ˆì„ í•œë‹¤.
  - ì¤‘ìš”í•œ ë‹¨ì–´ë‚˜ ë¬¸ìž¥ì€ **êµµê²Œ(Bold)** í‘œì‹œí•˜ì—¬ ëˆˆì— ë„ê²Œ í•œë‹¤.
  - ë¦¬ìŠ¤íŠ¸(1., -)ì™€ ì¸ìš©êµ¬(>)ë¥¼ ì ê·¹ í™œìš©í•˜ì—¬ í…ìŠ¤íŠ¸ ë©ì–´ë¦¬ë¥¼ ê¹¬ë‹¤.
- **ë‚´ìš© ì „ê°œ**:
  - **ë„ìž…ë¶€**: "í˜¹ì‹œ ì´ëŸ° ê³ ë¯¼ í•˜ì…¨ë‚˜ìš”?"ì™€ ê°™ì´ ë…ìžì˜ ìƒí™©ì„ ê¿°ëš«ëŠ” ì§ˆë¬¸ìœ¼ë¡œ ì‹œìž‘ (3ì´ˆ ì•ˆì— ì‚¬ë¡œìž¡ê¸°).
  - **ë³¸ë¬¸**: êµ¬ì²´ì ì¸ ì´ìœ ì™€ í•´ê²°ì±… ì œì‹œ. ë‹¨ìˆœížˆ "ì¢‹ë‹¤"ê°€ ì•„ë‹ˆë¼ "ì™œ ì¢‹ì€ì§€" ê²½í—˜ì— ë¹—ëŒ€ì–´ ì„¤ëª… ("ì œê°€ ì§ì ‘ ì¨ë³´ë‹ˆ~").
  - **ë§ˆë¬´ë¦¬**: ìš”ì•½ ë° ë”°ëœ»í•œ ì‘ì›.
- **ì–´ì¡°**: ì¹œê·¼í•œ ì˜†ì§‘ ì–¸ë‹ˆ/ì˜¤ë¹ ê°€ ì•Œë ¤ì£¼ëŠ” ë“¯í•œ ë‹¤ì •í•˜ê³  ì‹ ë¢°ê° ìžˆëŠ” ë§íˆ¬ ("~í•´ìš”", "~ëžë‹ˆë‹¤", "~ê±°ë“ ìš”"). í™•ì‹  ìžˆëŠ” ì–´ì¡° ì‚¬ìš©.

[ì¶œë ¥ í˜•ì‹(JSON)]
**ì¤‘ìš”: ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡(\`\`\`json)ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì‹œì˜¤. ì˜¤ì§ JSON ë¬¸ìžì—´ë§Œ ì¶œë ¥í•˜ì‹œì˜¤.**
{
  "title": "ì œëª© (ë§¤ë ¥ì ì¸ ì´ëª¨ì§€ í¬í•¨)",
  "outline": ["ì†Œì œëª©1", "ì†Œì œëª©2", "ì†Œì œëª©3"],
  "content": "ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì˜ ì „ì²´ ë³¸ë¬¸"
}
`;

  const response = await safeGenerate(() =>
    client.generateJson<AiGeneratedPost>(prompt),
  );

  return response;
};
